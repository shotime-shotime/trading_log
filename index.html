<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TradeLog - Professional Analytics</title>
    <script src="stocks.js"></script>
    <style>
        :root { --primary: #0078d4; --success: #28a745; --danger: #dc3545; --bg: #f4f7f9; --gold: #ffd700; --dark: #1a1a1a; }
        body { font-family: 'Segoe UI', 'Meiryo', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1000px; margin: auto; padding: 15px; }
        button, select, input, .goal-header span { cursor: pointer; touch-action: manipulation; }
        .period-controls { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 15px; position: sticky; top: 0; z-index: 101; }
        .period-nav { display: flex; gap: 5px; margin-bottom: 12px; }
        .period-nav button { flex: 1; padding: 10px; border: none; background: #eee; border-radius: 8px; font-weight: bold; color: #666; transition: 0.3s; font-size: 13px; }
        .period-nav button.active { background: var(--primary); color: white; }
        .jump-controls { display: flex; align-items: center; gap: 8px; }
        .jump-btn { background: var(--dark); color: white; border: none; padding: 10px 12px; border-radius: 6px; flex-shrink: 0; }
        #history-select { padding: 9px; border-radius: 6px; border: 1px solid #ddd; flex-grow: 1; width: 100%; }
        .period-display { text-align: center; font-size: 12px; font-weight: bold; color: var(--primary); margin-top: 10px; background: #eef6fc; padding: 8px; border-radius: 20px; }
        .asset-summary-bar { background: var(--dark); color: white; padding: 15px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; position: sticky; top: 140px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 4px solid var(--primary); }
        .asset-summary-bar .item { text-align: center; }
        .asset-summary-bar label { font-size: 10px; color: #aaa; display: block; margin-bottom: 3px; }
        .asset-summary-bar .value { font-size: 16px; font-weight: bold; }
        .goal-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .goal-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 8px; font-weight: bold; }
        .progress-bg { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, var(--primary), #00c6ff); height: 100%; transition: 0.5s; width: 0%; }
        #goal-edit-area { display: none; background: #f0f7ff; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 600px) { .analytics-grid { grid-template-columns: 1fr; } }
        .analytics-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .table-mini { width: 100%; font-size: 12px; border-collapse: collapse; }
        .table-mini th { text-align: left; color: #888; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .table-mini td { padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        section { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { margin-top: 0; font-size: 15px; border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.03); position: relative; border: 1px solid #eee; border-left-width: 5px; }
        .card.win { border-left-color: var(--success); }
        .card.loss { border-left-color: var(--danger); }
        .card-pl { font-size: 18px; font-weight: bold; margin-top: 5px; }
        .card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 5px; }
        .btn-mini { font-size: 10px; padding: 6px 10px; border: none; border-radius: 4px; font-weight: bold; }
        .btn-settle { background: var(--gold); color: #000; }
        .btn-edit { background: #e3f2fd; color: var(--primary); }
        .btn-delete { background: #ffebee; color: #c62828; }
        .edit-form { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); } }
        .exec-row { display: grid; grid-template-columns: 1.2fr 1fr 0.8fr; gap: 8px; margin-bottom: 8px; }
        .btn-main { background: var(--dark); color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; font-size: 15px; }
        input, select, textarea { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; background: white; }
        .edit-mode-active { border: 2px solid var(--primary) !important; background: #f0f7ff !important; }
        .settle-mode-active { border: 2px solid var(--gold) !important; background: #fffdf0 !important; }
        .pl-plus { color: var(--success) !important; }
        .pl-minus { color: var(--danger) !important; }

        /* Calendar Styles */
        #calendar-view { display: none; background: white; border-radius: 12px; padding: 10px; margin-bottom: 20px; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .cal-day-head { text-align: center; font-size: 10px; font-weight: bold; color: #888; padding: 5px 0; }
        .cal-cell { border: 1px solid #f0f0f0; min-height: 50px; padding: 2px; position: relative; display: flex; flex-direction: column; }
        .cal-date { font-size: 10px; color: #999; }
        .cal-pl { font-size: 8px; font-weight: bold; text-align: center; margin-top: auto; word-break: break-all; line-height: 1.1; }
        #calendar-total { margin-top: 10px; text-align: right; font-weight: bold; font-size: 13px; border-top: 1px dashed #eee; padding-top: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="period-controls">
        <div class="period-nav">
            <button id="btn-day" class="active" onclick="changeMode('day')">æœ¬æ—¥</button>
            <button id="btn-week" onclick="changeMode('week')">é€±æ¬¡</button>
            <button id="btn-month" onclick="changeMode('month')">æœˆæ¬¡</button>
            <button id="btn-year" onclick="changeMode('year')">å¹´æ¬¡</button>
        </div>
        <div class="jump-controls">
            <button class="jump-btn" onclick="offsetPeriod(-1)">â—€</button>
            <select id="history-select" onchange="jumpToHistory(this.value)"></select>
            <button class="jump-btn" onclick="offsetPeriod(1)">â–¶</button>
        </div>
        <div id="period-info" class="period-display"></div>
    </div>

    <div class="asset-summary-bar">
        <div class="item"><label>æœŸé–“æç›Š</label><div id="dash-period-pl" class="value">0</div></div>
        <div class="item"><label>é€šç®—æç›Š</label><div id="dash-total-before-tax" class="value">0</div></div>
        <div class="item"><label>ä¿æœ‰æ™‚ä¾¡</label><div id="dash-holdings-val" class="value" style="color:var(--gold)">0</div></div>
    </div>

    <div class="goal-container">
        <div class="goal-header">
            <span>ğŸ¯ æœŸé–“ç›®æ¨™é€²æ—</span>
            <span id="goal-text" onclick="toggleGoalEdit()" style="cursor:pointer; text-decoration:underline; color:var(--primary)">ç›®æ¨™è¨­å®š</span>
        </div>
        <div id="goal-edit-area">
            <div style="display:flex; gap:8px;">
                <input type="number" id="goal-input-val" placeholder="1æ—¥ã®ç›®æ¨™(å††)">
                <button class="btn-mini" style="background:var(--primary); color:white; width:70px;" onclick="applyGoal()">OK</button>
            </div>
        </div>
        <div class="progress-bg"><div id="goal-bar" class="progress-bar"></div></div>
    </div>

    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>ğŸ“Š éŠ˜æŸ„åˆ¥(TOP5)</h3>
            <table class="table-mini"><thead><tr><th>éŠ˜æŸ„</th><th>å‹ç‡</th><th>æç›Š</th></tr></thead><tbody id="stock-stats-body"></tbody></table>
        </div>
        <div class="analytics-card">
            <h3>ğŸ¢ ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥(TOP5)</h3>
            <table class="table-mini"><thead><tr><th>ã‚»ã‚¯ã‚¿ãƒ¼</th><th>å‹ç‡</th><th>æç›Š</th></tr></thead><tbody id="sector-stats-body"></tbody></table>
        </div>
    </div>

    <section>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>ğŸ“¦ ä¿æœ‰éŠ˜æŸ„</h3>
            <button class="btn-mini btn-settle" style="padding:10px 15px; color:white; background:var(--primary)" onclick="showHForm()">+ æ–°è¦ä¿æœ‰</button>
        </div>
        <div id="h-editor" style="display:none;" class="edit-form">
            <div class="form-grid">
                <input type="text" id="h-code" placeholder="ã‚³ãƒ¼ãƒ‰" onkeyup="searchStock('h')">
                <input type="text" id="h-name" placeholder="éŠ˜æŸ„å" readonly style="background:#eee">
                <input type="text" id="h-sector" placeholder="ã‚»ã‚¯ã‚¿ãƒ¼" readonly style="background:#eee">
                <input type="number" id="h-qty" placeholder="æ ªæ•°" step="100">
                <input type="number" id="h-buy" placeholder="å–å¾—å˜ä¾¡">
                <input type="number" id="h-now" placeholder="ç¾åœ¨å€¤">
            </div>
            <button class="btn-main" id="btn-h-save" style="background:var(--success)" onclick="saveHolding()">ä¿æœ‰éŠ˜æŸ„ã¨ã—ã¦ä¿å­˜</button>
            <button class="btn-main" style="background:#ccc; margin-top:5px;" onclick="hideHForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div id="holding-list"></div>
    </section>

    <section id="t-section">
        <h3>ğŸ“‰ æç›Šè¨˜éŒ²ãƒ»ç·¨é›†</h3>
        <div class="edit-form" id="t-form-container">
            <div id="settle-notice" style="display:none; color:var(--gold); background:#000; padding:10px; border-radius:4px; font-size:12px; margin-bottom:10px;">âš ï¸ æ±ºæ¸ˆãƒ¢ãƒ¼ãƒ‰: æšæ•°ã‚’èª¿æ•´ã—ã¦éƒ¨åˆ†åˆ©ç¢ºã‚‚å¯èƒ½ã§ã™</div>
            <div id="edit-notice" style="display:none; color:white; background:var(--primary); padding:10px; border-radius:4px; font-size:12px; margin-bottom:10px;">ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™</div>
            <div class="form-grid">
                <input type="date" id="t-date">
                <input type="text" id="t-code" placeholder="ã‚³ãƒ¼ãƒ‰" onkeyup="searchStock('t')">
                <input type="text" id="t-name" placeholder="éŠ˜æŸ„å" readonly style="background:#eee">
                <input type="text" id="t-sector" placeholder="ã‚»ã‚¯ã‚¿ãƒ¼" readonly style="background:#eee">
            </div>
            <div id="exec-list"></div>
            <div class="form-grid" style="margin-top:10px;">
                <button class="btn-mini" style="background:#eee; height:45px;" onclick="addRow()">+ è¡Œè¿½åŠ </button>
                <select id="t-side" style="height:45px;"><option value="è²·">è²·</option><option value="å£²">å£²</option></select>
            </div>
            <input type="number" id="t-manual-pl" placeholder="æç›Šã‚’æ‰‹å‹•å…¥åŠ›(ä»»æ„)" style="margin-top:10px;">
            <textarea id="t-memo" placeholder="ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ¡ãƒ¢..." style="width:100%; height:80px; margin-top:10px;"></textarea>
            <button class="btn-main" id="btn-t-save" onclick="saveTrade()">ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ä¿å­˜</button>
            <button id="btn-t-cancel" class="btn-main" style="display:none; background:#ccc;" onclick="resetTForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </section>

    <h3>ğŸ“œ å±¥æ­´</h3>
    <div id="calendar-view">
        <div id="calendar-grid"></div>
        <div id="calendar-total"></div>
    </div>
    <div id="history-list"></div>
</div>

<script>
    let trades = JSON.parse(localStorage.getItem('trade_logs')) || [];
    let holdings = JSON.parse(localStorage.getItem('trade_holdings')) || [];
    let goals = JSON.parse(localStorage.getItem('trade_goals')) || {day:0, week:0, month:0, year:0};
    let hIdx = -1, tEditIdx = -1, mode = 'day', offset = 0, isSettleMode = false, hEditIdx = -1;

    window.onload = () => { 
        document.getElementById('t-date').valueAsDate = new Date();
        changeMode('day'); resetTForm(); 
    };

    function saveAll() {
        localStorage.setItem('trade_logs', JSON.stringify(trades));
        localStorage.setItem('trade_holdings', JSON.stringify(holdings));
        localStorage.setItem('trade_goals', JSON.stringify(goals));
    }

    function toggleGoalEdit() {
        const area = document.getElementById('goal-edit-area');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
        document.getElementById('goal-input-val').value = goals.day || 0;
    }

    function applyGoal() {
        const d = parseInt(document.getElementById('goal-input-val').value) || 0;
        goals = { day: d, week: d*5, month: d*20, year: d*240 };
        saveAll(); document.getElementById('goal-edit-area').style.display = 'none'; render();
    }

    function changeMode(m) { mode = m; offset = 0; updatePeriodUI(); }
    function offsetPeriod(d) { offset += d; updatePeriodUI(); }
    function jumpToHistory(v) { offset = parseInt(v); updatePeriodUI(); }

    function updatePeriodUI() {
        const sel = document.getElementById('history-select'); sel.innerHTML = "";
        for (let i = 0; i >= -60; i--) {
            const opt = document.createElement('option'); opt.value = i; opt.selected = (i === offset); 
            opt.textContent = i === 0 ? "ç¾åœ¨ã®æœŸé–“" : Math.abs(i) + (mode==='day'?'æ—¥å‰':mode==='week'?'é€±å‰':mode==='month'?'æœˆå‰':'å¹´å‰');
            sel.appendChild(opt);
        }
        render();
    }

    function render() {
        let s = new Date(); s.setHours(0,0,0,0); let e = new Date(); e.setHours(23,59,59,999);
        if (mode === 'day') { s.setDate(s.getDate() + offset); e.setDate(e.getDate() + offset); }
        else if (mode === 'week') { s.setDate(s.getDate() - s.getDay() + (offset * 7)); e.setDate(s.getDate() + 6); }
        else if (mode === 'month') { s.setMonth(s.getMonth() + offset, 1); e = new Date(s.getFullYear(), s.getMonth() + 1, 0, 23, 59, 59); }
        else if (mode === 'year') { s.setFullYear(s.getFullYear() + offset, 0, 1); e.setFullYear(s.getFullYear() + offset, 11, 31); }
        
        document.getElementById('period-info').innerText = s.toLocaleDateString() + ' ã€œ ' + e.toLocaleDateString();
        
        document.querySelectorAll('.period-nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');

        // Toggle Calendar/List View
        const calArea = document.getElementById('calendar-view');
        const listArea = document.getElementById('history-list');
        if (mode === 'month') {
            calArea.style.display = 'block';
            listArea.style.display = 'none';
        } else {
            calArea.style.display = 'none';
            listArea.style.display = 'block';
        }

        let hHtml = ""; let totalMV = 0;
        holdings.forEach((h, i) => {
            const mv = (h.currentPrice || 0) * (h.qty || 0);
            const pl = mv - ((h.buyPrice || 0) * (h.qty || 0));
            totalMV += mv;
            const kabutanUrl = 'https://kabutan.jp/stock/chart?code=' + h.code;
            
            hHtml += '<div class="card ' + (pl>=0?'win':'loss') + '">' +
                '<div class="card-actions">' +
                    '<button class="btn-mini btn-settle" onclick="settleHolding('+i+')">æ±ºæ¸ˆ</button>' +
                    '<button class="btn-mini btn-edit" onclick="editHolding('+i+')">ç·¨é›†</button>' +
                    '<button class="btn-mini btn-delete" onclick="deleteHolding('+i+')">å‰Šé™¤</button>' +
                '</div>' +
                '<div style="font-size:10px; color:#888">' + h.code + '</div>' +
                '<div style="font-weight:bold">' + 
                    h.name + ' ' +
                    '<a href="' + kabutanUrl + '" target="_blank" style="text-decoration:none; font-size:12px;">ğŸ”</a>' + 
                    ' / ' + h.qty + 'æ ª' +
                '</div>' +
                '<div class="card-pl ' + (pl>=0?'pl-plus':'pl-minus') + '">' + mv.toLocaleString() + 'å†† (' + (pl>=0?'+':'') + pl.toLocaleString() + ')</div>' +
            '</div>';
        });
        document.getElementById('holding-list').innerHTML = hHtml || '<div style="text-align:center; padding:10px; color:#ccc;">ãªã—</div>';

        let pNet = 0, allNet = 0, statsS = {}, statsV = {}, tHtml = "";
        trades.forEach((t, i) => {
            allNet += (t.pl || 0);
            const d = new Date(t.date);
            if (d >= s && d <= e) {
                pNet += t.pl;
                const sk = t.name, vk = t.sector || "æœªåˆ†é¡";
                [ [statsS, sk], [statsV, vk] ].forEach(([obj, k]) => {
                    if(!obj[k]) obj[k] = {pl:0, win:0, count:0};
                    obj[k].pl += t.pl; obj[k].count++; if(t.pl > 0) obj[k].win++;
                });
                tHtml += '<div class="card ' + (t.pl>=0?'win':'loss') + '">' +
                    '<div class="card-actions"><button class="btn-mini btn-edit" onclick="editTrade('+i+')">ç·¨é›†</button><button class="btn-mini btn-delete" onclick="deleteTrade('+i+')">å‰Šé™¤</button></div>' +
                    '<div style="font-size:10px; color:#888">' + t.date + '</div><div style="font-weight:bold">' + t.name + ' (' + t.side + ')</div>' +
                    '<div class="card-pl ' + (t.pl>=0?'pl-plus':'pl-minus') + '">' + t.pl.toLocaleString() + 'å††</div>' +
                '</div>';
            }
        });

        if (mode === 'month') drawCalendar(s, pNet);

        document.getElementById('history-list').innerHTML = tHtml || '<div style="text-align:center; padding:20px; color:#ccc;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
        document.getElementById('dash-period-pl').innerText = pNet.toLocaleString() + "å††";
        document.getElementById('dash-total-before-tax').innerText = allNet.toLocaleString() + "å††";
        document.getElementById('dash-holdings-val').innerText = totalMV.toLocaleString() + "å††";
        
        const goal = goals[mode] || 0;
        const per = goal > 0 ? Math.min(100, Math.max(0, (pNet / goal) * 100)) : 0;
        document.getElementById('goal-text').innerText = goal > 0 ? 'ç›®æ¨™ ' + goal.toLocaleString() + 'å†† (' + Math.floor(per) + '%)' : "ç›®æ¨™è¨­å®š";
        document.getElementById('goal-bar').style.width = per + "%";

        const renderRank = (obj, id) => {
            let h = "";
            Object.keys(obj).sort((a,b)=>obj[b].pl - obj[a].pl).slice(0,5).forEach(k=>{
                h += '<tr><td>'+k+'</td><td>'+Math.round(obj[k].win/obj[k].count*100)+'%</td><td class="'+(obj[k].pl>=0?'pl-plus':'pl-minus')+'">'+obj[k].pl.toLocaleString()+'</td></tr>';
            });
            document.getElementById(id).innerHTML = h || '<tr><td colspan="3">-</td></tr>';
        };
        renderRank(statsS, 'stock-stats-body'); renderRank(statsV, 'sector-stats-body');
    }

    function drawCalendar(startDate, monthTotal) {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = "";
        ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => grid.innerHTML += `<div class="cal-day-head">${d}</div>`);
        
        const year = startDate.getFullYear();
        const month = startDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

        for(let d=1; d<=lastDate; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayPl = trades.filter(t => t.date === dateStr).reduce((sum, t) => sum + t.pl, 0);
            const plClass = dayPl > 0 ? 'pl-plus' : dayPl < 0 ? 'pl-minus' : '';
            const displayPl = dayPl !== 0 ? dayPl.toLocaleString() : '';
            
            grid.innerHTML += `<div class="cal-cell">
                <div class="cal-date">${d}</div>
                <div class="cal-pl ${plClass}">${displayPl}</div>
            </div>`;
        }
        document.getElementById('calendar-total').innerHTML = `${month + 1}æœˆã®åˆè¨ˆæç›Š: <span class="${monthTotal>=0?'pl-plus':'pl-minus'}">${monthTotal.toLocaleString()}å††</span>`;
    }

    function saveTrade() {
        const manualPl = document.getElementById('t-manual-pl').value;
        const side = document.getElementById('t-side').value;
        let details = [], totalQtyIn = 0, totalValIn = 0, totalQtyOut = 0, totalValOut = 0;
        document.querySelectorAll('.exec-row').forEach(r => {
            const p = parseFloat(r.querySelector('.e-p').value) || 0;
            const q = parseFloat(r.querySelector('.e-q').value) || 0;
            const t = r.querySelector('.e-t').value;
            details.push({p, q, t});
            if(t === 'entry') { totalQtyIn += q; totalValIn += p * q; }
            else { totalQtyOut += q; totalValOut += p * q; }
        });
        let finalPl = 0;
        if (manualPl !== "") { finalPl = parseInt(manualPl); }
        else if (totalQtyIn > 0 && totalQtyOut > 0) {
            const avgIn = totalValIn / totalQtyIn;
            const avgOut = totalValOut / totalQtyOut;
            finalPl = (side === 'è²·') ? (avgOut - avgIn) * totalQtyOut : (avgIn - avgOut) * totalQtyOut;
        }
        const data = {
            date: document.getElementById('t-date').value,
            code: document.getElementById('t-code').value,
            name: document.getElementById('t-name').value || 'æœªè¨­å®š',
            sector: document.getElementById('t-sector').value,
            side: side,
            pl: Math.round(finalPl),
            memo: document.getElementById('t-memo').value,
            details: details
        };
        if (tEditIdx > -1) trades[tEditIdx] = data; else trades.unshift(data);
        if (isSettleMode && hIdx > -1) {
            if (totalQtyOut >= holdings[hIdx].qty) holdings.splice(hIdx, 1);
            else holdings[hIdx].qty -= totalQtyOut;
        }
        saveAll(); resetTForm(); render();
    }

    function addRow(p="", q="", t="entry") {
        const d = document.createElement('div'); d.className = 'exec-row';
        d.innerHTML = '<input type="number" class="e-p" placeholder="å˜ä¾¡" value="'+p+'"><input type="number" class="e-q" placeholder="æšæ•°" value="'+q+'" step="100"><select class="e-t"><option value="entry" '+(t==='entry'?'selected':'')+'>IN</option><option value="exit" '+(t==='exit'?'selected':'')+'>OUT</option></select>';
        document.getElementById('exec-list').appendChild(d);
    }

    function editTrade(i) {
        tEditIdx = i; const t = trades[i];
        document.getElementById('t-form-container').className = 'edit-form edit-mode-active';
        document.getElementById('edit-notice').style.display = "block";
        document.getElementById('t-date').value = t.date;
        document.getElementById('t-code').value = t.code;
        document.getElementById('t-name').value = t.name;
        document.getElementById('t-sector').value = t.sector;
        document.getElementById('t-side').value = t.side;
        document.getElementById('t-memo').value = t.memo || "";
        document.getElementById('t-manual-pl').value = t.pl;
        document.getElementById('exec-list').innerHTML = "";
        if(t.details) t.details.forEach(d => addRow(d.p, d.q, d.t)); else addRow();
        document.getElementById('btn-t-cancel').style.display = "block";
        window.scrollTo({ top: document.getElementById('t-section').offsetTop - 150, behavior: 'smooth' });
    }

    function settleHolding(i) {
        const h = holdings[i]; isSettleMode = true; hIdx = i;
        document.getElementById('t-form-container').className = 'edit-form settle-mode-active';
        document.getElementById('settle-notice').style.display = "block";
        document.getElementById('t-code').value = h.code; document.getElementById('t-name').value = h.name;
        document.getElementById('t-sector').value = h.sector;
        document.getElementById('exec-list').innerHTML = "";
        addRow(h.buyPrice, h.qty, "entry"); addRow(h.currentPrice, h.qty, "exit");
        document.getElementById('btn-t-cancel').style.display = "block";
        window.scrollTo({ top: document.getElementById('t-section').offsetTop - 150, behavior: 'smooth' });
    }

    function resetTForm() {
        tEditIdx = -1; hIdx = -1; isSettleMode = false;
        document.getElementById('t-form-container').className = 'edit-form';
        document.getElementById('edit-notice').style.display = "none";
        document.getElementById('settle-notice').style.display = "none";
        document.getElementById('exec-list').innerHTML = ""; addRow();
        document.getElementById('t-manual-pl').value = ""; document.getElementById('t-code').value = "";
        document.getElementById('t-name').value = ""; document.getElementById('t-sector').value = "";
        document.getElementById('t-memo').value = ""; document.getElementById('btn-t-cancel').style.display = "none";
    }

    function searchStock(pre) {
        const c = document.getElementById(pre+'-code').value.trim();
        if(typeof STOCK_MASTER !== 'undefined' && STOCK_MASTER[c]) {
            document.getElementById(pre+'-name').value = STOCK_MASTER[c][0];
            document.getElementById(pre+'-sector').value = STOCK_MASTER[c][1];
        }
    }

    function showHForm() { 
        hEditIdx = -1; 
        document.getElementById('h-editor').style.display='block'; 
        document.getElementById('btn-h-save').innerText = "ä¿æœ‰éŠ˜æŸ„ã¨ã—ã¦ä¿å­˜";
        document.getElementById('h-code').value = ""; document.getElementById('h-name').value = "";
        document.getElementById('h-sector').value = ""; document.getElementById('h-qty').value = "";
        document.getElementById('h-buy').value = ""; document.getElementById('h-now').value = "";
    }
    function hideHForm() { document.getElementById('h-editor').style.display='none'; }
    
    function editHolding(i) {
        hEditIdx = i;
        const h = holdings[i];
        document.getElementById('h-editor').style.display = 'block';
        document.getElementById('btn-h-save').innerText = "æ›´æ–°ã™ã‚‹";
        document.getElementById('h-code').value = h.code;
        document.getElementById('h-name').value = h.name;
        document.getElementById('h-sector').value = h.sector;
        document.getElementById('h-qty').value = h.qty;
        document.getElementById('h-buy').value = h.buyPrice;
        document.getElementById('h-now').value = h.currentPrice;
        window.scrollTo({ top: document.getElementById('h-editor').offsetTop - 100, behavior: 'smooth' });
    }

    function saveHolding() {
        const code = document.getElementById('h-code').value.trim();
        const name = document.getElementById('h-name').value;
        const sector = document.getElementById('h-sector').value;
        const qty = parseFloat(document.getElementById('h-qty').value) || 0;
        const buyPrice = parseFloat(document.getElementById('h-buy').value) || 0;
        const inputNow = parseFloat(document.getElementById('h-now').value);

        if (!code) { alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        const existIdx = holdings.findIndex(h => h.code === code);

        if (hEditIdx > -1) {
            holdings[hEditIdx] = { code, name, sector, qty, buyPrice, currentPrice: (isNaN(inputNow) ? holdings[hEditIdx].currentPrice : inputNow) };
        } else if (existIdx > -1) {
            const old = holdings[existIdx];
            const newQty = old.qty + qty;
            const newAvg = ((old.buyPrice * old.qty) + (buyPrice * qty)) / newQty;
            holdings[existIdx].qty = newQty;
            holdings[existIdx].buyPrice = Math.round(newAvg);
            if (!isNaN(inputNow)) holdings[existIdx].currentPrice = inputNow;
        } else {
            holdings.unshift({ code, name, sector, qty, buyPrice, currentPrice: (isNaN(inputNow) ? 0 : inputNow) });
        }
        saveAll(); hideHForm(); render();
    }
    function deleteTrade(i) { if(confirm("å‰Šé™¤ï¼Ÿ")) { trades.splice(i,1); saveAll(); render(); } }
    function deleteHolding(i) { if(confirm("å‰Šé™¤ï¼Ÿ")) { holdings.splice(i,1); saveAll(); render(); } }
</script>
</body>
</html>
