<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>TradeLog - Professional Analytics</title>
    <script src="stocks.js"></script>
    <style>
        :root { --primary: #0078d4; --success: #28a745; --danger: #dc3545; --bg: #f4f7f9; --gold: #ffd700; --dark: #1a1a1a; }
        body { font-family: 'Segoe UI', 'Meiryo', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .container { max-width: 1000px; margin: auto; padding: 20px; }
        
        .period-controls { 
            background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin-bottom: 15px; position: sticky; top: 0; z-index: 101; 
        }
        .period-nav { display: flex; gap: 5px; margin-bottom: 12px; }
        .period-nav button { flex: 1; padding: 10px; border: none; background: #eee; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .period-nav button.active { background: var(--primary); color: white; }
        .jump-controls { display: flex; align-items: center; gap: 10px; }
        .jump-btn { background: var(--dark); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
        #history-select { padding: 9px; border-radius: 6px; border: 1px solid #ddd; flex-grow: 1; }
        .period-display { text-align: center; font-size: 13px; font-weight: bold; color: var(--primary); margin-top: 10px; background: #eef6fc; padding: 8px; border-radius: 20px; }

        .asset-summary-bar { 
            background: var(--dark); color: white; padding: 20px; border-radius: 12px; 
            display: grid; grid-template-columns: 1fr 1.2fr 1.8fr; gap: 15px; margin-bottom: 15px; 
            position: sticky; top: 150px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 4px solid var(--primary); 
        }
        .asset-summary-bar .item { text-align: center; border-right: 1px solid #444; }
        .asset-summary-bar label { font-size: 11px; color: #aaa; display: block; margin-bottom: 5px; }
        .asset-summary-bar .value { font-size: 22px; font-weight: bold; }

        .goal-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .goal-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 8px; font-weight: bold; }
        .progress-bg { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, var(--primary), #00c6ff); height: 100%; transition: 0.5s; width: 0%; }

        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .analytics-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .table-mini { width: 100%; font-size: 12px; border-collapse: collapse; }
        .table-mini th { text-align: left; color: #888; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .table-mini td { padding: 8px 0; border-bottom: 1px solid #f9f9f9; }

        section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { margin-top: 0; font-size: 15px; border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 15px; }
        
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.03); position: relative; border: 1px solid #eee; border-left-width: 5px; }
        .card.win { border-left-color: var(--success); }
        .card.loss { border-left-color: var(--danger); }
        .card-pl { font-size: 18px; font-weight: bold; margin-top: 5px; }
        .pl-plus { color: var(--success); }
        .pl-minus { color: var(--danger); }

        .card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 5px; }
        .btn-mini { font-size: 10px; padding: 3px 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-settle { background: var(--gold); color: #000; }
        .btn-edit { background: #e3f2fd; color: var(--primary); }
        .btn-delete { background: #ffebee; color: #c62828; }

        .edit-form { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: 80px 1fr 100px 80px 80px; gap: 8px; margin-bottom: 10px; }
        .btn-main { background: var(--dark); color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        input, select, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .edit-form-highlight { border: 2px solid var(--gold) !important; background: #fffdf0 !important; }
        .edit-mode-active { border: 2px solid var(--primary) !important; background: #f0f7ff !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="period-controls">
        <div class="period-nav">
            <button id="btn-day" class="active" onclick="changeMode('day')">æœ¬æ—¥</button>
            <button id="btn-week" onclick="changeMode('week')">é€±æ¬¡</button>
            <button id="btn-month" onclick="changeMode('month')">æœˆæ¬¡</button>
            <button id="btn-year" onclick="changeMode('year')">å¹´æ¬¡</button>
        </div>
        <div class="jump-controls">
            <button class="jump-btn" onclick="offsetPeriod(-1)">â—€</button>
            <select id="history-select" onchange="jumpToHistory(this.value)"></select>
            <button class="jump-btn" onclick="offsetPeriod(1)">â–¶</button>
        </div>
        <div id="period-info" class="period-display"></div>
    </div>

    <div class="asset-summary-bar">
        <div class="item"><label>æœŸé–“æç›Š</label><div id="dash-period-pl" class="value">0</div></div>
        <div class="item"><label>é€šç®—(ç¨å¼•å‰)</label><div id="dash-total-before-tax" class="value">0</div><div id="dash-total-pl" style="font-size:10px; opacity:0.7"></div></div>
        <div class="item"><label>ä¿æœ‰æ™‚ä¾¡</label><div id="dash-holdings-val" class="value" style="color:var(--gold)">0</div><div id="dash-holdings-diff" style="font-size:11px"></div></div>
    </div>

    <div class="goal-container">
        <div class="goal-header"><span>ğŸ¯ æœŸé–“ç›®æ¨™é€²æ—</span><span id="goal-text" onclick="setGoal()" style="cursor:pointer; text-decoration:underline;">ç›®æ¨™è¨­å®š</span></div>
        <div class="progress-bg"><div id="goal-bar" class="progress-bar"></div></div>
    </div>

    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>ğŸ“Š éŠ˜æŸ„åˆ¥(TOP5)</h3>
            <table class="table-mini"><thead><tr><th>éŠ˜æŸ„</th><th>å‹ç‡</th><th>æç›Š</th></tr></thead><tbody id="stock-stats-body"></tbody></table>
        </div>
        <div class="analytics-card">
            <h3>ğŸ¢ ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥(TOP5)</h3>
            <table class="table-mini"><thead><tr><th>ã‚»ã‚¯ã‚¿ãƒ¼</th><th>å‹ç‡</th><th>æç›Š</th></tr></thead><tbody id="sector-stats-body"></tbody></table>
        </div>
    </div>

    <section>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>ğŸ“¦ ä¿æœ‰éŠ˜æŸ„</h3>
            <button class="btn-mini btn-settle" style="padding:10px 15px; color:white; background:var(--primary)" onclick="showHForm()">+ æ–°è¦ä¿æœ‰</button>
        </div>
        <div id="h-editor" style="display:none;" class="edit-form">
            <div class="form-grid">
                <input type="text" id="h-code" placeholder="ã‚³ãƒ¼ãƒ‰" onkeyup="searchStock('h')">
                <input type="text" id="h-name" placeholder="éŠ˜æŸ„å" readonly style="background:#eee">
                <input type="text" id="h-sector" placeholder="ã‚»ã‚¯ã‚¿ãƒ¼" readonly style="background:#eee">
                <input type="number" id="h-qty" placeholder="æ ªæ•°">
                <input type="number" id="h-buy" placeholder="å–å¾—å˜ä¾¡">
            </div>
            <input type="number" id="h-now" placeholder="ç¾åœ¨å€¤" style="width:120px;">
            <button class="btn-main" style="background:var(--success)" onclick="saveHolding()">ä¿å­˜</button>
            <button class="btn-main" style="background:#ccc; margin-top:5px;" onclick="hideHForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div id="holding-list"></div>
    </section>

    <section id="t-section">
        <h3>ğŸ“‰ æç›Šè¨˜éŒ²ãƒ»ç·¨é›†</h3>
        <div class="edit-form" id="t-form-container">
            <div id="settle-notice" style="display:none; color:var(--gold); background:#000; padding:5px 10px; border-radius:4px; font-size:11px; margin-bottom:10px;">âš ï¸ æ±ºæ¸ˆãƒ¢ãƒ¼ãƒ‰: å†…å®¹ã‚’ç¢ºèªã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„</div>
            <div id="edit-notice" style="display:none; color:white; background:var(--primary); padding:5px 10px; border-radius:4px; font-size:11px; margin-bottom:10px;">ğŸ“ å±¥æ­´ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: å†…å®¹ã‚’ä¿®æ­£ã—ã¦ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„</div>
            
            <div style="display:grid; grid-template-columns: 140px 100px 1fr 120px; gap:10px; margin-bottom:10px;">
                <input type="date" id="t-date">
                <input type="text" id="t-code" placeholder="ã‚³ãƒ¼ãƒ‰" onkeyup="searchStock('t')">
                <input type="text" id="t-name" readonly style="background:#eee">
                <input type="text" id="t-sector" readonly style="background:#eee" placeholder="ã‚»ã‚¯ã‚¿ãƒ¼">
            </div>
            <div id="exec-list"></div>
            <div style="margin-top:10px;">
                <button class="btn-mini" style="background:#eee;" onclick="addRow()">+ è¡Œè¿½åŠ </button>
                <select id="t-side" style="margin-left:10px;"><option value="è²·">è²·</option><option value="å£²">å£²</option></select>
                <span style="font-size:11px; color:#888; margin-left:10px;">â€»ç·¨é›†æ™‚ã¯ç›´æ¥ã€Œæç›Šé¡ã€ã®ã¿ä¿®æ­£ã‚‚å¯â†’</span>
                <input type="number" id="t-manual-pl" placeholder="æç›Šã‚’æ‰‹å‹•å…¥åŠ›" style="width:120px;">
            </div>
            <textarea id="t-memo" placeholder="ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ¡ãƒ¢..." style="width:100%; height:50px; margin-top:10px;"></textarea>
            <button class="btn-main" id="btn-t-save" onclick="saveTrade()">ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ä¿å­˜</button>
            <button id="btn-t-cancel" class="btn-main" style="display:none; background:#ccc;" onclick="resetTForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </section>

    <h3>ğŸ“œ å±¥æ­´</h3>
    <div id="history-list"></div>

    <div class="admin-section">
        <button class="btn-admin" onclick="refreshPastSectors()">ğŸ”„ éå»ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ãƒã‚¹ã‚¿ã¨åŒæœŸ</button>
        <button class="btn-admin" onclick="exportData()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    </div>
</div>

<script>
    let trades = JSON.parse(localStorage.getItem('trade_logs')) || [];
    let holdings = JSON.parse(localStorage.getItem('trade_holdings')) || [];
    let goals = JSON.parse(localStorage.getItem('trade_goals')) || {day:0, week:0, month:0, year:0};
    
    let hIdx = -1; // ä¿æœ‰éŠ˜æŸ„ã®ç·¨é›†ç”¨
    let tEditIdx = -1; // å±¥æ­´ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ç·¨é›†ç”¨
    let mode = 'day', offset = 0, isSettleMode = false;
    const TAX = 0.20315;

    window.onload = () => { changeMode('day'); resetTForm(); };

    function saveAll() {
        localStorage.setItem('trade_logs', JSON.stringify(trades));
        localStorage.setItem('trade_holdings', JSON.stringify(holdings));
        localStorage.setItem('trade_goals', JSON.stringify(goals));
    }

    // ç›®æ¨™è¨­å®š
    function setGoal() {
        const d = prompt("1æ—¥ã®ç›®æ¨™åˆ©ç›Šï¼ˆå††ï¼‰:", goals.day || 0);
        if (d === null) return;
        const dayGoal = parseInt(d) || 0;
        if (confirm("ä»–ã®æœŸé–“ã‚‚è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ")) {
            goals.day = dayGoal; goals.week = dayGoal * 5; goals.month = dayGoal * 20; goals.year = dayGoal * 240;
        } else {
            goals.day = dayGoal;
        }
        saveAll(); render();
    }

    // æœŸé–“åˆ‡ã‚Šæ›¿ãˆ
    function changeMode(m) { mode = m; offset = 0; updatePeriodUI(); }
    function offsetPeriod(d) { offset += d; updatePeriodUI(); }
    function jumpToHistory(v) { offset = parseInt(v); updatePeriodUI(); }

    function updatePeriodUI() {
        document.querySelectorAll('.period-nav button').forEach(b => b.classList.toggle('active', b.id === `btn-${mode}`));
        const sel = document.getElementById('history-select'); sel.innerHTML = "";
        for (let i = 0; i >= -60; i--) {
            const opt = document.createElement('option'); opt.value = i; opt.selected = (i === offset); 
            opt.textContent = i === 0 ? "ç¾åœ¨" : Math.abs(i) + (mode==='day'?'æ—¥å‰':mode==='week'?'é€±å‰':mode==='month'?'æœˆå‰':'å¹´å‰');
            sel.appendChild(opt);
        }
        render();
    }

    function getRange() {
        let s = new Date(); s.setHours(0,0,0,0);
        let e = new Date(); e.setHours(23,59,59,999);
        if (mode === 'day') { s.setDate(s.getDate() + offset); e.setDate(e.getDate() + offset); }
        else if (mode === 'week') { s.setDate(s.getDate() - s.getDay() + (offset * 7)); e.setDate(s.getDate() + 6); }
        else if (mode === 'month') { s.setMonth(s.getMonth() + offset, 1); e = new Date(s.getFullYear(), s.getMonth() + 1, 0, 23, 59, 59); }
        else if (mode === 'year') { s.setFullYear(s.getFullYear() + offset, 0, 1); e.setFullYear(s.getFullYear() + offset, 11, 31); }
        return { s, e };
    }

    // æç”»ãƒ¡ã‚¤ãƒ³
    function render() {
        const range = getRange();
        document.getElementById('period-info').innerText = `${range.s.toLocaleDateString()} ã€œ ${range.e.toLocaleDateString()}`;
        
        // ä¿æœ‰
        let hHtml = "", totalMV = 0, totalFloating = 0;
        holdings.forEach((h, i) => {
            const mv = (h.currentPrice || 0) * (h.qty || 0);
            const pl = mv - ((h.buyPrice || 0) * (h.qty || 0));
            totalMV += mv; totalFloating += pl;
            hHtml += `<div class="card ${pl>=0?'win':'loss'}">
                <div class="card-actions"><button class="btn-mini btn-settle" onclick="settleHolding(${i})">æ±ºæ¸ˆ</button><button class="btn-mini btn-delete" onclick="deleteHolding(${i})">æ¶ˆ</button></div>
                <div style="font-size:10px; color:#888">${h.code} | ${h.sector || ''}</div>
                <div style="font-weight:bold">${h.name} / ${h.qty}æ ª</div>
                <div class="card-pl ${pl>=0?'pl-plus':'pl-minus'}">${mv.toLocaleString()}å†† (${pl>=0?'+':''}${pl.toLocaleString()})</div>
            </div>`;
        });
        document.getElementById('holding-list').innerHTML = hHtml || '<div style="text-align:center; padding:10px; color:#ccc;">ãªã—</div>';

        // å±¥æ­´
        let pNet = 0, allNet = 0, statsS = {}, statsV = {}, tHtml = "";
        trades.forEach((t, i) => {
            allNet += t.pl;
            const d = new Date(t.date);
            if (d >= range.s && d <= range.e) {
                pNet += t.pl;
                const sKey = t.name; const vKey = t.sector || "æœªåˆ†é¡";
                [ [statsS, sKey], [statsV, vKey] ].forEach(([obj, k]) => {
                    if(!obj[k]) obj[k] = {pl:0, win:0, count:0};
                    obj[k].pl += t.pl; obj[k].count++; if(t.pl > 0) obj[k].win++;
                });
                tHtml += `<div class="card ${t.pl>=0?'win':'loss'}">
                    <div class="card-actions">
                        <button class="btn-mini btn-edit" onclick="editTrade(${i})">ç·¨é›†</button>
                        <button class="btn-mini btn-delete" onclick="deleteTrade(${i})">å‰Šé™¤</button>
                    </div>
                    <div style="font-size:10px; color:#888">${t.date} | ${t.code}</div>
                    <div style="font-weight:bold">${t.name} (${t.side})</div>
                    <div class="card-pl ${t.pl>=0?'pl-plus':'pl-minus'}">${t.pl.toLocaleString()}å††</div>
                    ${t.memo ? `<div style="font-size:11px; color:#666; margin-top:5px; border-top:1px dashed #eee; padding-top:5px;">${t.memo}</div>` : ''}
                </div>`;
            }
        });
        document.getElementById('history-list').innerHTML = tHtml || '<div style="text-align:center; padding:20px; color:#ccc;">å±¥æ­´ãªã—</div>';

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        document.getElementById('dash-period-pl').innerText = pNet.toLocaleString() + "å††";
        document.getElementById('dash-period-pl').className = "value " + (pNet>=0?'pl-plus':'pl-minus');
        document.getElementById('dash-total-before-tax').innerText = allNet.toLocaleString() + "å††";
        document.getElementById('dash-total-pl').innerText = `(ç¨å¼•å¾Œ: ${Math.floor(allNet>0?allNet*(1-TAX):allNet).toLocaleString()}å††)`;
        document.getElementById('dash-holdings-val').innerText = totalMV.toLocaleString() + "å††";
        document.getElementById('dash-holdings-diff').innerText = `(${totalFloating>=0?'+':''}${totalFloating.toLocaleString()})`;
        
        // ç›®æ¨™ãƒãƒ¼
        const goal = goals[mode] || 0;
        const per = goal > 0 ? Math.min(100, Math.max(0, (pNet / goal) * 100)) : 0;
        document.getElementById('goal-text').innerText = goal > 0 ? `ç›®æ¨™ ${goal.toLocaleString()}å†† (${Math.floor(per)}%)` : "ç›®æ¨™æœªè¨­å®š";
        document.getElementById('goal-bar').style.width = per + "%";

        // çµ±è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        const renderRank = (obj, id) => {
            let h = "";
            Object.keys(obj).sort((a,b)=>obj[b].pl - obj[a].pl).slice(0,5).forEach(k=>{
                h += `<tr><td>${k}</td><td>${Math.round(obj[k].win/obj[k].count*100)}%</td><td class="${obj[k].pl>=0?'pl-plus':'pl-minus'}">${obj[k].pl.toLocaleString()}</td></tr>`;
            });
            document.getElementById(id).innerHTML = h;
        };
        renderRank(statsS, 'stock-stats-body'); renderRank(statsV, 'sector-stats-body');
    }

    // ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ã®å‰Šé™¤
    function deleteTrade(i) {
        if(confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            trades.splice(i, 1); saveAll(); render();
        }
    }

    // ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ã®ç·¨é›†é–‹å§‹
    function editTrade(i) {
        tEditIdx = i;
        const t = trades[i];
        document.getElementById('t-form-container').classList.add('edit-mode-active');
        document.getElementById('edit-notice').style.display = "block";
        document.getElementById('t-date').value = t.date;
        document.getElementById('t-code').value = t.code;
        document.getElementById('t-name').value = t.name;
        document.getElementById('t-sector').value = t.sector || "";
        document.getElementById('t-side').value = t.side;
        document.getElementById('t-memo').value = t.memo || "";
        document.getElementById('t-manual-pl').value = t.pl;
        document.getElementById('exec-list').innerHTML = ""; // ç·¨é›†æ™‚ã¯æ‰‹å‹•è¨ˆç®—ã‚’å„ªå…ˆ
        document.getElementById('btn-t-cancel').style.display = "block";
        document.getElementById('btn-t-save').innerText = "ä¿®æ­£å†…å®¹ã§ä¸Šæ›¸ãä¿å­˜";
        window.scrollTo(0, document.getElementById('t-section').offsetTop - 160);
    }

    // ãƒˆãƒ¬ãƒ¼ãƒ‰ä¿å­˜ï¼ˆæ–°è¦ãƒ»æ±ºæ¸ˆãƒ»ç·¨é›†å…±é€šï¼‰
    function saveTrade() {
        const manualPl = document.getElementById('t-manual-pl').value;
        let finalPl = 0;

        if (manualPl !== "") {
            finalPl = parseInt(manualPl);
        } else {
            const ps = document.querySelectorAll('.e-p'), qs = document.querySelectorAll('.e-q'), ts = document.querySelectorAll('.e-t');
            let iV=0, oV=0;
            ps.forEach((p,i) => { 
                const pv=parseFloat(p.value)||0, qv=parseFloat(qs[i].value)||0; 
                if(ts[i].value==='entry') iV+=pv*qv; else oV+=pv*qv; 
            });
            finalPl = (document.getElementById('t-side').value==='è²·'?(oV-iV):(iV-oV));
        }

        const data = {
            date: document.getElementById('t-date').value || new Date().toISOString().split('T')[0],
            code: document.getElementById('t-code').value,
            name: document.getElementById('t-name').value,
            sector: document.getElementById('t-sector').value,
            side: document.getElementById('t-side').value,
            pl: finalPl,
            memo: document.getElementById('t-memo').value
        };

        if (tEditIdx > -1) {
            trades[tEditIdx] = data; // ç·¨é›†ä¸Šæ›¸ã
        } else {
            trades.unshift(data); // æ–°è¦è¿½åŠ 
        }

        if(isSettleMode && hIdx > -1) holdings.splice(hIdx, 1);
        
        saveAll(); resetTForm(); render();
    }

    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    function resetTForm() {
        tEditIdx = -1; hIdx = -1; isSettleMode = false;
        document.getElementById('t-form-container').classList.remove('edit-form-highlight', 'edit-mode-active');
        document.getElementById('settle-notice').style.display = "none";
        document.getElementById('edit-notice').style.display = "none";
        document.getElementById('exec-list').innerHTML = ""; addRow();
        document.getElementById('t-manual-pl').value = "";
        document.getElementById('t-memo').value = "";
        document.getElementById('btn-t-cancel').style.display = "none";
        document.getElementById('btn-t-save').innerText = "ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ä¿å­˜";
    }

    // --- ãã®ä»–æ—¢å­˜é–¢æ•° ---
    function searchStock(pre) {
        const c = document.getElementById(pre+'-code').value.trim();
        if(typeof STOCK_MASTER !== 'undefined' && STOCK_MASTER[c]) {
            document.getElementById(pre+'-name').value = STOCK_MASTER[c][0];
            document.getElementById(pre+'-sector').value = STOCK_MASTER[c][1];
        }
    }
    function showHForm() { hIdx = -1; document.getElementById('h-editor').style.display='block'; }
    function hideHForm() { document.getElementById('h-editor').style.display='none'; }
    function saveHolding() {
        const d = { 
            code: document.getElementById('h-code').value, name: document.getElementById('h-name').value, 
            sector: document.getElementById('h-sector').value, qty: parseFloat(document.getElementById('h-qty').value)||0, 
            buyPrice: parseFloat(document.getElementById('h-buy').value)||0, currentPrice: parseFloat(document.getElementById('h-now').value)||0 
        };
        holdings.unshift(d); saveAll(); hideHForm(); render();
    }
    function settleHolding(i) {
        const h = holdings[i]; isSettleMode = true; hIdx = i;
        document.getElementById('t-form-container').classList.add('edit-form-highlight');
        document.getElementById('settle-notice').style.display = "block";
        document.getElementById('t-code').value = h.code; document.getElementById('t-name').value = h.name;
        document.getElementById('t-sector').value = h.sector;
        document.getElementById('exec-list').innerHTML = "";
        addRow(h.buyPrice, h.qty, "entry"); addRow(h.currentPrice, h.qty, "exit");
        document.getElementById('btn-t-cancel').style.display = "block";
        window.scrollTo(0, document.getElementById('t-section').offsetTop - 160);
    }
    function addRow(p="", q="", t="entry") {
        const d = document.createElement('div'); d.className = 'form-grid';
        d.innerHTML = `<input type="number" class="e-p" placeholder="å˜ä¾¡" value="${p}"><input type="number" class="e-q" placeholder="æ•°" value="${q}" style="grid-column:span 2"><select class="e-t" style="grid-column:span 2"><option value="entry" ${t==='entry'?'selected':''}>IN</option><option value="exit" ${t==='exit'?'selected':''}>OUT</option></select>`;
        document.getElementById('exec-list').appendChild(d);
    }
    function deleteHolding(i) { if(confirm("æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) { holdings.splice(i,1); saveAll(); render(); } }
    function exportData() { const blob = new Blob([JSON.stringify({trades,holdings,goals})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'TradeLog_Backup.json'; a.click(); }
    function refreshPastSectors() {
        trades = trades.map(t => { if(STOCK_MASTER[t.code]) { t.name=STOCK_MASTER[t.code][0]; t.sector=STOCK_MASTER[t.code][1]; } return t; });
        saveAll(); render(); alert("åŒæœŸå®Œäº†");
    }
</script>
</body>
</html>